<div class="dashboard">
  <h2>GRC Dashboard</h2>
  <p>Cliquez sur un domaine pour dérouler ses sous-domaines.</p>

  <div class="controls">
    <button (click)="checkBackend()">Vérifier le backend</button>

    <button class="btn-danger" (click)="logout()">Déconnexion</button>
    <span class="status" *ngIf="status">{{ status }}</span>
  </div>

  <div class="grid" [ngSwitch]="currentUserRole" style="margin-top: 20px;">
    <app-risk-dashboard *ngSwitchCase="UserRole.RISK_MANAGER" [filteredModules]="filteredModules"
      title="Dashboard Risk Manager" (openModule)="openSubmoduleModal($event.m, $event.s)">
    </app-risk-dashboard>

    <app-risk-dashboard *ngSwitchCase="UserRole.RISK_AGENT" [filteredModules]="filteredModules"
      title="Dashboard Risk Agent" (openModule)="openSubmoduleModal($event.m, $event.s)">
    </app-risk-dashboard>

    <app-audit-dashboard *ngSwitchCase="UserRole.AUDIT_SENIOR" [filteredModules]="filteredModules"
      title="Dashboard Audit Senior" (openModule)="openSubmoduleModal($event.m, $event.s)">
    </app-audit-dashboard>

    <app-audit-dashboard *ngSwitchCase="UserRole.AUDITEUR" [filteredModules]="filteredModules"
      title="Dashboard Auditeur" (openModule)="openSubmoduleModal($event.m, $event.s)">
    </app-audit-dashboard>

    <app-admin-si-dashboard *ngSwitchCase="UserRole.ADMIN_SI" [filteredModules]="filteredModules"
      (openModule)="openSubmoduleModal($event.m, $event.s)">
    </app-admin-si-dashboard>

    <app-top-management-dashboard *ngSwitchCase="UserRole.TOP_MANAGEMENT" [filteredModules]="filteredModules"
      (openModule)="openSubmoduleModal($event.m, $event.s)">
    </app-top-management-dashboard>

    <!-- Default view if no role or error (optional) -->
    <div *ngSwitchDefault>
      <p>Chargement de votre espace personnalisé...</p>
    </div>
  </div>
</div>

<app-modal *ngIf="modalVisible && !creating" [title]="modalTitle" (close)="closeModal()">
  <div modal-body [innerHTML]="modalBody"></div>
  <div modal-footer>
    <button (click)="startCreate()">Créer</button>
  </div>
  <!-- mark projected content for modal detection -->
  <div #projected style="display:none"></div>
</app-modal>

<app-modal *ngIf="modalVisible && creating" [title]="modalTitle" (close)="closeModal()">
  <div modal-body>
    <h4>Créer une configuration — {{ currentSubmoduleTitle }}</h4>
    <div class="form-row">
      <label>Nom</label>
      <input [(ngModel)]="form.name" />
    </div>
    <div class="form-row">
      <label>Description</label>
      <textarea rows="3" [(ngModel)]="form.description"></textarea>
    </div>
    <div class="form-row">
      <label>Configuration (JSON)</label>
      <textarea rows="8" [(ngModel)]="form.config"></textarea>
    </div>
  </div>
  <div modal-footer>
    <button (click)="submitForm()">Créer</button>
    <button (click)="closeModal()">Annuler</button>
  </div>
  <div #projected style="display:none"></div>
</app-modal>

<!-- AI Assistant -->
<app-ai-assistant></app-ai-assistant>